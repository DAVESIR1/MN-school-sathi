#!/bin/bash
# ============================================================
# EDUNORM SANDBOX GUARD â€” Git Pre-commit Hook
# Runs automatically before EVERY commit.
# Blocks any commit that violates sandbox isolation rules.
#
# To bypass (ADMIN ONLY): git commit --no-verify
# This must be approved by the admin and documented.
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo ""
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}  ğŸ›¡ï¸  EduNorm Sandbox Guard â€” Pre-commit Check${NC}"
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

VIOLATIONS=0

# â”€â”€â”€ Rule 1: No cross-feature imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "${YELLOW}â–¶ Checking: Cross-feature import isolation...${NC}"

# Get only staged JS/JSX files inside src/features/
STAGED_FEATURE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^src/features/[^/]+/.*\.(js|jsx|ts|tsx)$')

if [ -n "$STAGED_FEATURE_FILES" ]; then
    while IFS= read -r file; do
        FEATURE=$(echo "$file" | sed 's|src/features/\([^/]*\)/.*|\1|')
        
        # Check for imports from other feature folders (relative paths going up to another feature)
        # Pattern: ../../OtherFeature or ../../../features/OtherFeature
        CROSS_IMPORTS=$(grep -n "from '.*features/[^']*'" "$file" 2>/dev/null | grep -v "from '.*features/${FEATURE}" || true)
        
        if [ -n "$CROSS_IMPORTS" ]; then
            echo ""
            echo -e "${RED}${BOLD}  ğŸš« SANDBOX VIOLATION in: ${file}${NC}"
            echo -e "${RED}  Cross-feature import detected:${NC}"
            echo "$CROSS_IMPORTS" | while IFS= read -r line; do
                echo -e "${RED}    Line $line${NC}"
            done
            echo ""
            echo -e "${YELLOW}  FIX: Use AppBus.emit(APP_EVENTS.X, data) instead of direct imports.${NC}"
            echo -e "${YELLOW}  See SANDBOX_RULES.md for guidance.${NC}"
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    done <<< "$STAGED_FEATURE_FILES"
fi

# â”€â”€â”€ Rule 2: No feature logic in App.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "${YELLOW}â–¶ Checking: App.jsx stays a thin shell...${NC}"
if git diff --cached --name-only | grep -q "^src/App.jsx$"; then
    LINES=$(wc -l < src/App.jsx)
    if [ "$LINES" -gt 600 ]; then
        echo ""
        echo -e "${RED}${BOLD}  âš ï¸  WARNING: App.jsx has ${LINES} lines (max recommended: 600)${NC}"
        echo -e "${YELLOW}  App.jsx is getting bloated. Move feature logic to feature sandboxes.${NC}"
        # This is a warning, not a hard block
    fi
fi

# â”€â”€â”€ Rule 3: Every new feature folder must have a manifest.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "${YELLOW}â–¶ Checking: New features have manifest.js...${NC}"
STAGED_NEW_FEATURES=$(git diff --cached --name-only --diff-filter=A | grep -E '^src/features/[^/]+/view\.(js|jsx)$')

if [ -n "$STAGED_NEW_FEATURES" ]; then
    while IFS= read -r file; do
        FEATURE=$(echo "$file" | sed 's|src/features/\([^/]*\)/.*|\1|')
        if [ ! -f "src/features/${FEATURE}/manifest.js" ]; then
            echo ""
            echo -e "${RED}${BOLD}  ğŸš« MISSING MANIFEST: src/features/${FEATURE}/manifest.js${NC}"
            echo -e "${YELLOW}  Every new feature MUST have a manifest.js to register with FeatureRegistry.${NC}"
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    done <<< "$STAGED_NEW_FEATURES"
fi

# â”€â”€â”€ Rule 4: AppBus event types must be declared in APP_EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "${YELLOW}â–¶ Checking: AppBus events use declared constants...${NC}"
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx)$')
if [ -n "$STAGED_JS" ]; then
    # Check for string literals in AppBus.emit() â€” should use APP_EVENTS.X
    BAD_EMIT=$(grep -n "AppBus\.emit('[^']*'" $STAGED_JS 2>/dev/null || true)
    if [ -n "$BAD_EMIT" ]; then
        echo ""
        echo -e "${RED}${BOLD}  âš ï¸  AppBus.emit() used with string literal instead of APP_EVENTS constant:${NC}"
        echo "$BAD_EMIT" | head -5
        echo -e "${YELLOW}  Use: AppBus.emit(APP_EVENTS.YOUR_EVENT, data)${NC}"
        # Warning only â€” strings still work, but constants are safer
    fi
fi

# â”€â”€â”€ Final Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ $VIOLATIONS -gt 0 ]; then
    echo -e "${RED}${BOLD}  âŒ COMMIT BLOCKED â€” ${VIOLATIONS} isolation violation(s) found${NC}"
    echo ""
    echo -e "${YELLOW}  Fix the violations above, then commit again.${NC}"
    echo -e "${YELLOW}  Admin override: git commit --no-verify (requires documentation)${NC}"
    echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 1
else
    echo -e "${GREEN}${BOLD}  âœ… All sandbox rules passed â€” commit allowed${NC}"
    echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 0
fi
